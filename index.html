<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lion Tech Solutions - Soluciones Digitales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Confetti.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for view switching */
        .view {
            transition: opacity 0.3s ease-in-out;
        }
        #loader, #geminiLoader {
            border-top-color: #3b82f6; /* Blue accent for loader */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Animation for product cards */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.1);
            }
        }
        .animate-pulse-glow {
            animation: pulse-glow 3s infinite;
        }
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            object-fit: cover;
        }
        /* Fire effect animation for the discount button */
        @keyframes fire-pulse {
            50% {
                box-shadow: 0 0 25px 5px rgba(234, 88, 12, 0.7);
            }
        }
        .animate-fire-pulse {
            animation: fire-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Fire effect for text */
        @keyframes fire-text-glow {
            50% {
                text-shadow: 0 0 15px rgba(251, 191, 36, 0.8), 0 0 5px rgba(234, 88, 12, 0.6);
            }
        }
        .animate-fire-text {
            animation: fire-text-glow 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <video autoplay loop muted playsinline id="background-video">
        <source src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/Cielo%20estrellado%20sin%20copyright.mp4" type="video/mp4">
        Tu navegador no soporta videos HTML5.
    </video>
    <div class="fixed inset-0 bg-black opacity-60 z-[-50]"></div>
    
    <!-- Audio Player -->
    <audio id="background-music" loop>
        <source src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/space-ambient-music.mp3" type="audio/mpeg">
    </audio>

    <!-- Music Toggle Button -->
    <button id="music-toggle" class="fixed bottom-4 right-4 z-[100] bg-black p-3 rounded-full text-white hover:bg-gray-800 transition-colors">
        <svg id="icon-muted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
        </svg>
        <svg id="icon-playing" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
    </button>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAo7Ic5G5Y-BX1sy3QI_c7xxvtUHMmKiK0",
            authDomain: "streaming-web-e645d.firebaseapp.com",
            projectId: "streaming-web-e645d",
            storageBucket: "streaming-web-e645d.firebasestorage.app",
            messagingSenderId: "474770009460",
            appId: "1:474770009460:web:efeba58f4cee95a22a9021",
            measurementId: "G-B3D9GP845Q"
        };
        const appId = "streaming-web-e645d"; // Use the projectId from your configuration

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        // --- DOM ELEMENTS ---
        const publicView = document.getElementById('publicView');
        const adminView = document.getElementById('adminView');
        const productsGrid = document.getElementById('productsGrid');
        const noResults = document.getElementById('noResults');
        const searchInput = document.getElementById('searchInput');
        const adminProductsList = document.getElementById('adminProductsList');
        const productForm = document.getElementById('productForm');
        const formTitle = document.getElementById('formTitle');
        const productIdInput = document.getElementById('productId');
        const cancelButton = document.getElementById('cancelButton');
        const formLoader = document.getElementById('formLoader');
        const saveButton = document.getElementById('saveButton');
        const settingsButton = document.getElementById('settingsButton');
        const passwordModal = document.getElementById('passwordModal');
        const passwordForm = document.getElementById('passwordForm');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const closeModalButton = document.getElementById('closeModalButton');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeImageModal = document.getElementById('closeImageModal');
        const generateDescButton = document.getElementById('generateDescButton');
        const geminiLoader = document.getElementById('geminiLoader');
        const serviceNameInput = document.getElementById('name');
        const descriptionTextarea = document.getElementById('description');
        const authErrorModal = document.getElementById('authErrorModal');
        const closeAuthErrorModal = document.getElementById('closeAuthErrorModal');
        const firestoreRulesModal = document.getElementById('firestoreRulesModal');
        const closeRulesModal = document.getElementById('closeRulesModal');
        const firestoreWriteRulesModal = document.getElementById('firestoreWriteRulesModal');
        const closeWriteRulesModal = document.getElementById('closeWriteRulesModal');
        const musicToggle = document.getElementById('music-toggle');
        const backgroundMusic = document.getElementById('background-music');
        const iconMuted = document.getElementById('icon-muted');
        const iconPlaying = document.getElementById('icon-playing');
        const discountButton = document.getElementById('discountButton');
        const discountModal = document.getElementById('discountModal');
        const closeDiscountModal = document.getElementById('closeDiscountModal');
        const openScheduleButton = document.getElementById('openScheduleButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const closeScheduleModal = document.getElementById('closeScheduleModal');
        const statusIndicator = document.getElementById('statusIndicator');
        const descriptionModal = document.getElementById('descriptionModal');
        const closeDescriptionModal = document.getElementById('closeDescriptionModal');
        const modalProductName = document.getElementById('modalProductName');
        const modalProductImage = document.getElementById('modalProductImage');
        const modalProductDescription = document.getElementById('modalProductDescription');
        const modalWhatsAppButton = document.getElementById('modalWhatsAppButton');
        const modalProductPrice = document.getElementById('modalProductPrice');


        let allProducts = []; // Local cache for searching
        let isAppInitialized = false;

        // --- ROUTING ---
        function handleRouteChange() {
            switch(window.location.hash) {
                case '#admin':
                    publicView.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    break;
                default:
                    publicView.classList.remove('hidden');
                    adminView.classList.add('hidden');
            }
        }

        // Setup routing listeners immediately on script load
        window.addEventListener('hashchange', handleRouteChange);
        document.addEventListener('DOMContentLoaded', handleRouteChange);


        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!isAppInitialized) {
                    initializeAppLogic(user.uid);
                    isAppInitialized = true;
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    if (error.code === 'auth/configuration-not-found') {
                        authErrorModal.classList.remove('hidden');
                    }
                }
            }
        });

        // --- DATA HANDLING ---
        function listenForProducts(userId) {
            const productsCollection = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsCollection, (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts);
                renderAdminList(allProducts);
                searchProducts();
            }, (error) => {
                console.error("Error fetching products: ", error);
                if (error.code === 'permission-denied') {
                    firestoreRulesModal.classList.remove('hidden');
                }
            });
        }

        // --- GEMINI API FUNCTION ---
        async function generateDescriptionWithGemini(serviceName) {
            geminiLoader.classList.remove('hidden');
            generateDescButton.disabled = true;

            const prompt = `Eres un experto en marketing digital para una empresa de tecnología en Costa Rica llamada 'Lion Tech Solutions'. Escribe una descripción de producto atractiva y profesional para un servicio llamado '${serviceName}'. La descripción debe ser concisa, de unas 25-40 palabras, y destacar los beneficios para el cliente. El tono debe ser profesional y confiable.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };
            const apiKey = firebaseConfig.apiKey; // Use the API key from your config
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    descriptionTextarea.value = text.trim();
                } else {
                    console.error("Unexpected API response structure:", result);
                    descriptionTextarea.value = "No se pudo generar una descripción. Por favor, inténtalo de nuevo.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                descriptionTextarea.value = "Error al contactar la IA. Verifica la conexión y vuelve a intentarlo.";
            } finally {
                geminiLoader.classList.add('hidden');
                generateDescButton.disabled = false;
            }
        }

        // --- RENDERING ---
        function renderProducts(productsToRender) {
            if (productsToRender.length === 0 && searchInput.value === '') {
                productsGrid.innerHTML = '<p class="text-center col-span-full text-gray-400">No hay servicios disponibles en este momento.</p>';
                noResults.classList.add('hidden');
                return;
            }
            if (productsToRender.length === 0 && searchInput.value !== '') {
                productsGrid.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            productsGrid.innerHTML = productsToRender.map(product => {
                const imageUrl = product.imageUrl || 'https://placehold.co/600x400/1f2937/ffffff?text=Servicio';
                
                let stockInfo;
                if (product.useRandomStock) {
                    stockInfo = `<span class="inline-block bg-green-800 text-green-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">Disponibles: ${Math.floor(Math.random() * 7) + 1}</span>`;
                } else {
                    const fixedStock = product.fixedStock || 0;
                    if (fixedStock > 0) {
                        stockInfo = `<span class="inline-block bg-green-800 text-green-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">Disponibles: ${fixedStock}</span>`;
                    } else {
                        stockInfo = `<span class="inline-block bg-red-800 text-red-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">Agotado</span>`;
                    }
                }
                
                const isLowStock = !product.useRandomStock && (product.fixedStock || 0) > 0 && (product.fixedStock || 0) <= 10;
                const titleContent = isLowStock
                    ? `<span class="text-yellow-400 text-sm block animate-pulse">¡ÚLTIMAS UNIDADES!</span> ${product.name}`
                    : product.name;

                return `
                <div class="product-card bg-black rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 flex flex-col border border-gray-700 animate-pulse-glow">
                    <div class="relative group cursor-pointer view-image-btn" data-img-src="${imageUrl}">
                        <img src="${imageUrl}" alt="Imagen de ${product.name}" class="w-full h-48 object-contain bg-gray-900" onerror="this.onerror=null;this.src='https://placehold.co/600x400/ef4444/ffffff?text=Error+de+Imagen';">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-300 flex items-center justify-center">
                            <svg class="w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                        </div>
                    </div>
                    <div class="p-6 flex-grow flex flex-col">
                        <div class="flex items-baseline justify-between gap-3 mb-2">
                            <span class="inline-block bg-blue-900 text-blue-200 text-xs font-semibold px-2.5 py-0.5 rounded-full">${product.category || 'General'}</span>
                            ${stockInfo}
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">${titleContent}</h3>
                        <p class="text-gray-400 text-sm mb-4 flex-grow truncate">${product.description}</p>
                        <div class="product-footer bg-gray-900 -m-6 mt-4 p-4 border-t border-gray-700">
                            <div class="flex justify-between items-center">
                                <button data-id="${product.id}" class="view-description-btn text-blue-400 hover:text-blue-300 text-sm font-semibold">Ver Más</button>
                                <div class="flex items-center gap-3">
                                    <span class="text-xl font-bold text-blue-400">₡${(product.price || 0).toLocaleString('es-CR')}</span>
                                    <a href="https://wa.me/50670285433?text=${encodeURIComponent(`¡Hola! Me interesa el servicio "${product.name}"`)}" target="_blank" class="whatsapp-btn inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300 text-sm">
                                        <span>Consultar</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAdminList(products) {
             adminProductsList.innerHTML = products.map(p => {
                const stockDisplay = p.useRandomStock ? 'Azar Activado' : `Fijo: ${p.fixedStock || 0}`;
                return `
                <div class="bg-black p-4 rounded-lg shadow-sm flex items-center justify-between border border-gray-700">
                    <div>
                        <p class="font-bold text-white">${p.name}</p>
                        <p class="text-sm text-gray-400">₡${(p.price || 0).toLocaleString('es-CR')} - Stock: ${stockDisplay}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${p.id}" class="edit-btn bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md">Editar</button>
                        <button data-id="${p.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-md">Eliminar</button>
                    </div>
                </div>`;
             }).join('');
        }

        // --- FORM & CRUD LOGIC ---
        function resetForm() {
            productForm.reset();
            productIdInput.value = '';
            formTitle.textContent = 'Añadir Nuevo Servicio';
            cancelButton.classList.add('hidden');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            formLoader.classList.remove('hidden');
            saveButton.disabled = true;

            const formData = new FormData(e.target);
            const productData = {
                name: formData.get('name'),
                description: formData.get('description'),
                price: Number(formData.get('price')),
                category: formData.get('category'),
                imageUrl: formData.get('imageUrl'),
                fixedStock: Number(formData.get('fixedStock')),
                useRandomStock: formData.get('useRandomStock') === 'on',
            };

            const productId = productIdInput.value;
            try {
                if (productId) {
                    const productRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
                    await updateDoc(productRef, productData);
                } else {
                    const productsCollection = collection(db, `artifacts/${appId}/public/data/products`);
                    await addDoc(productsCollection, productData);
                }
                resetForm();
            } catch (error) {
                console.error("Error saving product:", error);
                if (error.code === 'permission-denied') {
                    firestoreWriteRulesModal.classList.remove('hidden');
                }
            } finally {
                formLoader.classList.add('hidden');
                saveButton.disabled = false;
            }
        }

        function handleAdminListClick(e) {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('edit-btn')) {
                const product = allProducts.find(p => p.id === id);
                if (product) {
                    formTitle.textContent = 'Editar Servicio';
                    productIdInput.value = product.id;
                    productForm.name.value = product.name;
                    productForm.description.value = product.description;
                    productForm.price.value = product.price;
                    productForm.category.value = product.category;
                    productForm.imageUrl.value = product.imageUrl || '';
                    productForm.fixedStock.value = product.fixedStock || 0;
                    productForm.useRandomStock.checked = product.useRandomStock || false;
                    cancelButton.classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
            } else if (target.classList.contains('delete-btn')) {
                if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                    const productRef = doc(db, `artifacts/${appId}/public/data/products`, id);
                    deleteDoc(productRef).catch(error => console.error("Error deleting product:", error));
                }
            }
        }
        
        // --- SEARCH ---
        function searchProducts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredProducts = allProducts.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                product.description.toLowerCase().includes(searchTerm)
            );
            renderProducts(filteredProducts);
        }
        
        // --- APP INITIALIZATION ---
        function initializeAppLogic(userId) {
            // Event Listeners
            searchInput.addEventListener('input', searchProducts);
            productForm.addEventListener('submit', handleFormSubmit);
            adminProductsList.addEventListener('click', handleAdminListClick);
            cancelButton.addEventListener('click', resetForm);
            
            settingsButton.addEventListener('click', () => {
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
            });

            closeModalButton.addEventListener('click', () => {
                passwordModal.classList.add('hidden');
                passwordError.classList.add('hidden');
                passwordInput.value = '';
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === '2050') {
                    window.location.hash = '#admin';
                    passwordModal.classList.add('hidden');
                    passwordInput.value = '';
                    passwordError.classList.add('hidden');
                } else {
                    passwordError.classList.remove('hidden');
                }
            });

            productsGrid.addEventListener('click', (e) => {
                const viewImageBtn = e.target.closest('.view-image-btn');
                const viewDescBtn = e.target.closest('.view-description-btn');

                if (viewImageBtn) {
                    const imgSrc = viewImageBtn.dataset.imgSrc;
                    if (imgSrc) {
                        modalImage.src = imgSrc;
                        imageModal.classList.remove('hidden');
                    }
                } else if (viewDescBtn) {
                    const productId = viewDescBtn.dataset.id;
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        modalProductName.textContent = product.name;
                        modalProductImage.src = product.imageUrl || 'https://placehold.co/600x400/1f2937/ffffff?text=Servicio';
                        modalProductDescription.textContent = product.description;
                        modalProductPrice.textContent = `₡${(product.price || 0).toLocaleString('es-CR')}`;
                        const whatsappLink = `https://wa.me/50670285433?text=${encodeURIComponent(`¡Hola! Me interesa el servicio "${product.name}"`)}`;
                        modalWhatsAppButton.href = whatsappLink;
                        descriptionModal.classList.remove('hidden');
                    }
                }
            });

            function closeImageModalHandler() {
                imageModal.classList.add('hidden');
                modalImage.src = ''; // Clear src to prevent showing old image briefly
            }

            closeImageModal.addEventListener('click', closeImageModalHandler);
            imageModal.addEventListener('click', (e) => {
                if (e.target.id === 'imageModal') {
                    closeImageModalHandler();
                }
            });

            closeDescriptionModal.addEventListener('click', () => {
                descriptionModal.classList.add('hidden');
            });

            modalWhatsAppButton.addEventListener('click', (e) => {
                e.preventDefault(); 
                const button = e.currentTarget;
                const originalText = button.innerHTML;
                button.innerHTML = 'Redirigiendo...';
                button.disabled = true;

                const url = button.href;
                setTimeout(() => {
                    window.open(url, '_blank');
                    descriptionModal.classList.add('hidden');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);
            });

            generateDescButton.addEventListener('click', () => {
                const serviceName = serviceNameInput.value;
                if (serviceName.trim()) {
                    generateDescriptionWithGemini(serviceName);
                } else {
                    alert("Por favor, introduce un nombre de servicio primero.");
                }
            });

            closeAuthErrorModal.addEventListener('click', () => {
                authErrorModal.classList.add('hidden');
            });

            closeRulesModal.addEventListener('click', () => {
                firestoreRulesModal.classList.add('hidden');
            });
            
            closeWriteRulesModal.addEventListener('click', () => {
                firestoreWriteRulesModal.classList.add('hidden');
            });

            // Music Toggle Logic
            musicToggle.addEventListener('click', () => {
                if (backgroundMusic.paused) {
                    backgroundMusic.play();
                    iconMuted.classList.add('hidden');
                    iconPlaying.classList.remove('hidden');
                } else {
                    backgroundMusic.pause();
                    iconMuted.classList.remove('hidden');
                    iconPlaying.classList.add('hidden');
                }
            });

            discountButton.addEventListener('click', () => {
                confetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 }
                });
                discountModal.classList.remove('hidden');
            });

            closeDiscountModal.addEventListener('click', () => {
                discountModal.classList.add('hidden');
            });

            // Schedule Logic
            function updateScheduleStatus() {
                // Costa Rica is UTC-6
                const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Costa_Rica"}));
                const currentHour = now.getHours();
                if (currentHour >= 8 && currentHour < 22) {
                    statusIndicator.textContent = '¡Estamos abiertos!';
                    statusIndicator.classList.remove('text-red-400');
                    statusIndicator.classList.add('text-green-400');
                } else {
                    statusIndicator.textContent = 'Estamos cerrados';
                    statusIndicator.classList.remove('text-green-400');
                    statusIndicator.classList.add('text-red-400');
                }
            }

            openScheduleButton.addEventListener('click', () => {
                updateScheduleStatus();
                scheduleModal.classList.remove('hidden');
            });

            closeScheduleModal.addEventListener('click', () => {
                scheduleModal.classList.add('hidden');
            });

            listenForProducts(userId); // Initial data fetch
        }

    </script>
    
    <!-- Auth Error Modal -->
    <div id="authErrorModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-red-900 p-8 rounded-lg shadow-xl w-full max-w-md border border-red-700 text-white">
            <h3 class="text-xl font-bold mb-4">Error de Configuración de Firebase</h3>
            <p class="mb-4">La página no se pudo conectar a la base de datos. Es muy probable que necesites activar el "Inicio de sesión anónimo" en tu proyecto de Firebase.</p>
            <p class="text-sm text-red-200 mb-4"><b>Instrucciones:</b> Ve a tu Consola de Firebase → Authentication → Sign-in method → Activa "Anónimo".</p>
            <button id="closeAuthErrorModal" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>

    <!-- Firestore Write Rules Error Modal -->
    <div id="firestoreWriteRulesModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-red-900 p-8 rounded-lg shadow-xl w-full max-w-lg border border-red-700 text-white">
            <h3 class="text-xl font-bold mb-4">¡Acción Requerida! Permiso para Guardar Cambios</h3>
            <p class="mb-4">No se pudo guardar el producto porque la base de datos no tiene permisos de escritura. Necesitas actualizar las reglas para permitir que el panel de administrador guarde los cambios.</p>
            <p class="text-sm text-red-200 mb-2"><b>Instrucciones:</b></p>
            <ol class="list-decimal list-inside text-sm space-y-1 mb-4">
                <li>Ve a tu Consola de Firebase → Compilación → <b>Firestore Database</b>.</li>
                <li>Haz clic en la pestaña <b>"Reglas"</b>.</li>
                <li>Borra todo el texto y pega el siguiente código:</li>
            </ol>
            <pre class="bg-gray-800 p-3 rounded-md text-xs text-white overflow-x-auto mb-4"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/{document=**} {
      allow read: if true;
      allow write: if request.auth != null; // Permite escribir si el usuario está autenticado (incluso anónimamente)
    }
  }
}</code></pre>
            <p class="text-sm text-red-200 mb-4">4. Haz clic en <b>"Publicar"</b> y luego intenta guardar el producto de nuevo.</p>
            <button id="closeWriteRulesModal" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>

    <!-- Firestore Read Rules Error Modal -->
    <div id="firestoreRulesModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-red-900 p-8 rounded-lg shadow-xl w-full max-w-lg border border-red-700 text-white">
            <h3 class="text-xl font-bold mb-4">¡Acción Requerida! Error de Permisos de Base de Datos</h3>
            <p class="mb-4">La página no puede cargar los productos porque la base de datos no tiene los permisos correctos. Este es el último paso de la configuración.</p>
            <p class="text-sm text-red-200 mb-2"><b>Instrucciones:</b></p>
            <ol class="list-decimal list-inside text-sm space-y-1 mb-4">
                <li>Ve a tu Consola de Firebase → Compilación → <b>Firestore Database</b>.</li>
                <li>Haz clic en la pestaña <b>"Reglas"</b>.</li>
                <li>Borra todo el texto y pega el siguiente código:</li>
            </ol>
            <pre class="bg-gray-800 p-3 rounded-md text-xs text-white overflow-x-auto mb-4"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}</code></pre>
            <p class="text-sm text-red-200 mb-4">4. Haz clic en <b>"Publicar"</b> y recarga esta página.</p>
            <button id="closeRulesModal" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-md">Entendido</button>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-black p-8 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Acceso de Administrador</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="passwordForm">
                <label for="passwordInput" class="block text-sm font-medium text-gray-300 mb-2">Contraseña</label>
                <input type="password" id="passwordInput" class="w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta. Inténtalo de nuevo.</p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-black p-8 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center">
            <h3 class="text-2xl font-bold text-white mb-2">¡Premio Mayor!</h3>
            <p class="text-yellow-400 text-3xl font-bold animate-pulse mb-4">Tu descuento es... ¡0%!</p>
            <button id="closeDiscountModal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-6">Cerrar</button>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100] hidden p-4">
        <div class="relative">
            <button id="closeImageModal" class="absolute -top-4 -right-4 text-white bg-gray-800 rounded-full p-2 hover:bg-gray-700 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="modalImage" src="" alt="Vista ampliada del producto" class="max-w-screen-lg max-h-[80vh] object-contain rounded-lg">
        </div>
    </div>
    
    <!-- Description Modal -->
    <div id="descriptionModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-black p-6 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 relative">
            <button id="closeDescriptionModal" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h3 id="modalProductName" class="text-2xl font-bold text-white mb-4"></h3>
            <img id="modalProductImage" src="" alt="Imagen del producto" class="w-full h-64 object-contain rounded-md mb-4 bg-gray-900">
            <p id="modalProductDescription" class="text-gray-300"></p>
            <p id="modalProductPrice" class="text-3xl font-bold text-blue-400 text-center my-4"></p>
            <a id="modalWhatsAppButton" href="#" target="_blank" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md text-center inline-block">
                Comprar por WhatsApp
            </a>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-black p-8 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center">
            <h3 class="text-2xl font-bold text-white mb-4">Nuestro Horario</h3>
            <p class="text-gray-300 text-lg">Lunes a Domingo</p>
            <p class="text-gray-300 text-lg mb-4">8:00 AM - 10:00 PM</p>
            <div id="statusIndicator" class="text-lg font-bold p-2 rounded-md"></div>
            <button id="closeScheduleModal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-6">Cerrar</button>
        </div>
    </div>


    <!-- Public View -->
    <div id="publicView" class="view relative z-10">
        <header class="bg-black shadow-md sticky top-0 z-40 border-b border-gray-700">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/LionTech%20Solutions.jpg" alt="Lion Tech Solutions Logo" class="h-20">
                    <div class="flex items-center gap-4">
                        <a href="https://drive.google.com/file/d/1DxhPjzMomcbh2ai-JBJCDcLnAOm1eqY7/view?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-yellow-400 hover:text-white transition-colors hidden md:block animate-fire-text">
                            COMO USAR IPTV Y QUE OFRECE
                        </a>
                         <a href="https://drive.google.com/file/d/1DxhPjzMomcbh2ai-JBJCDcLnAOm1eqY7/view?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors md:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </a>
                        <a href="https://www.instagram.com/liontech_solutionscr" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors">
                            <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-08-10_044426691.png" alt="Instagram" class="h-6 w-6">
                        </a>
                        <a href="https://www.facebook.com/PauCr2" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors">
                            <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/imagen_2025-08-10_044516051.png" alt="Facebook" class="h-6 w-6">
                        </a>
                        <button id="settingsButton" class="text-gray-400 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8 md:py-12">
             <!-- Announcement Banner -->
            <div id="announcement-banner" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4 text-center relative rounded-lg mb-8 shadow-lg">
                <p class="font-bold text-gray-900">
                    ¡OFERTA ESPECIAL! 
                    <span class="font-normal">Contrata 3 meses y te damos el 4to mes GRATIS. Además, si 2 referidos tuyos compran, ¡tu próximo mes es GRATIS!</span>
                </p>
            </div>

            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-4">Todo lo que Necesitas, en un Solo Lugar</h2>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
                    <button id="discountButton" class="bg-gradient-to-r from-red-600 via-orange-500 to-yellow-400 text-white font-extrabold py-3 px-6 rounded-full transition-transform duration-300 animate-fire-pulse transform hover:scale-105">
                        DESCUENTO SI ERES GUAPO
                    </button>
                    <button id="openScheduleButton" class="bg-gradient-to-r from-blue-600 via-cyan-500 to-green-400 text-white font-extrabold py-3 px-6 rounded-full transition-transform duration-300 animate-fire-pulse transform hover:scale-105">
                        HORARIO DE TRABAJO
                    </button>
                </div>
                <div class="relative max-w-lg mx-auto">
                    <input type="text" class="w-full py-3 pl-5 pr-12 text-gray-200 bg-black border border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar servicios..." id="searchInput">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="productsGrid">
                <!-- Product cards will be dynamically inserted here -->
            </div>
            
            <div class="text-center py-16 hidden" id="noResults">
                <h3 class="mt-2 text-xl font-semibold text-white">No se encontraron servicios</h3>
            </div>
        </main>
    </div>

    <!-- Admin View -->
    <div id="adminView" class="view hidden relative z-10">
        <main class="container mx-auto px-6 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Panel de Administración</h2>
                <a href="#" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    ← Retroceder
                </a>
            </div>
            
            <!-- Form Card -->
            <div class="bg-black p-6 rounded-lg shadow-md mb-8 border border-gray-700">
                <h3 id="formTitle" class="text-2xl font-bold text-white mb-4">Añadir Nuevo Servicio</h3>
                <form id="productForm" class="space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300">Nombre del Servicio</label>
                        <input type="text" name="name" id="name" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-300">Descripción</label>
                        <div class="relative">
                            <textarea name="description" id="description" rows="3" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 pr-28"></textarea>
                            <button type="button" id="generateDescButton" class="absolute top-2 right-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded-md text-xs flex items-center gap-1">
                                ✨ Generar
                                <div id="geminiLoader" class="hidden w-4 h-4 border-2 border-white rounded-full loader"></div>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-300">Precio (₡)</label>
                            <input type="number" name="price" id="price" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-300">Categoría</label>
                            <input type="text" name="category" id="category" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="imageUrl" class="block text-sm font-medium text-gray-300">URL de la Imagen</label>
                        <input type="url" name="imageUrl" id="imageUrl" placeholder="https://ejemplo.com/imagen.png" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="fixedStock" class="block text-sm font-medium text-gray-300">Cantidad Fija</label>
                            <input type="number" name="fixedStock" id="fixedStock" required class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500" min="0" value="0">
                        </div>
                        <div class="flex items-end pb-1">
                            <div class="flex items-center">
                                <input type="checkbox" name="useRandomStock" id="useRandomStock" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                                <label for="useRandomStock" class="ml-2 block text-sm text-gray-200">Usar Stock al Azar</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button type="submit" id="saveButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Guardar Servicio</button>
                        <button type="button" id="cancelButton" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">Cancelar Edición</button>
                        <div id="formLoader" class="hidden w-6 h-6 border-4 border-gray-600 rounded-full loader"></div>
                    </div>
                </form>
            </div>

            <!-- List Card -->
            <div class="bg-black p-6 rounded-lg shadow-md border border-gray-700">
                <h3 class="text-2xl font-bold text-white mb-4">Servicios Existentes</h3>
                <div id="adminProductsList" class="space-y-4">
                    <!-- Admin product list will be dynamically inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-black mt-16 border-t border-gray-700 relative z-10">
        <div class="container mx-auto px-6 py-8 text-center">
             <img src="https://klgmrtkgaayyhzdwnclt.supabase.co/storage/v1/object/public/manu12/LionTech%20Solutions.jpg" alt="Lion Tech Solutions Logo" class="h-16 mx-auto mb-4">
            <p class="text-gray-500 text-sm mt-4">&copy; 2025 Lion Tech Solutions. Todos los derechos reservados.</p>
        </div>
    </footer>

</body>
</html>



